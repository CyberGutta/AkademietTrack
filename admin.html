<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkademiTrack - Admin Panel</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            color: #1e40af;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-title {
            font-size: 2rem;
            font-weight: 700;
        }

        .admin-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #22c55e;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .sign-out-btn {
            padding: 0.6rem 1.5rem;
            background: linear-gradient(45deg, #dc2626, #ef4444);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sign-out-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            min-height: calc(100vh - 200px);
        }

        .conversations-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            color: #374151;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .conversation-count {
            font-size: 0.9rem;
            background: #3b82f6;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            margin-right: -0.5rem;
            padding-right: 0.5rem;
        }

        .conversation-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .conversation-item:hover {
            background: #f8fafc;
            border-color: #3b82f6;
        }

        .conversation-item.active {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .user-email {
            font-weight: 600;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .conversation-time {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .last-message {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .conversation-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.open {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-badge.closed {
            background: #fee2e2;
            color: #dc2626;
        }

        .unread-count {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .chat-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 0;
            color: #374151;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-details h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.2rem;
        }

        .user-details p {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .conversation-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f3f4f6;
        }

        .action-btn.close {
            background: #fee2e2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .action-btn.close:hover {
            background: #fecaca;
        }

        .messages-container {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.admin {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.admin .message-bubble {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }

        .message-info {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 0.3rem;
            padding: 0 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message-type {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .reply-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .reply-form {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .reply-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            resize: none;
            min-height: 40px;
            max-height: 80px;
            font-family: inherit;
        }

        .reply-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .reply-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .reply-btn:hover:not(:disabled) {
            background: #2563eb;
            transform: scale(1.05);
        }

        .reply-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .no-conversation {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            font-size: 1.1rem;
            text-align: center;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280;
            text-align: center;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .stats-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: #374151;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }

            .admin-header {
                flex-direction: column;
                text-align: center;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .conversations-panel {
                max-height: 300px;
            }

            .chat-panel {
                min-height: 400px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .stats-bar {
                grid-template-columns: 1fr;
            }

            .conversation-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.3rem;
            }
        }

        /* Scrollbar styles */
        .conversations-list::-webkit-scrollbar,
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .conversations-list::-webkit-scrollbar-track,
        .messages-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .conversations-list::-webkit-scrollbar-thumb,
        .messages-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .conversations-list::-webkit-scrollbar-thumb:hover,
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <div>
                <h1 class="admin-title">AkademiTrack Admin Panel</h1>
                <p>Administrer bruker chat og support henvendelser</p>
            </div>
            <div class="admin-controls">
                <div class="status-toggle">
                    <span>Online Status:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="status-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="sign-out-btn" onclick="signOut()">Logg Ut</button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="total-conversations">-</div>
                <div class="stat-label">Totale Samtaler</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="unread-messages">-</div>
                <div class="stat-label">Uleste Meldinger</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="open-conversations">-</div>
                <div class="stat-label">Ã…pne Samtaler</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="total-messages">-</div>
                <div class="stat-label">Totale Meldinger</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Conversations Panel -->
            <div class="conversations-panel">
                <div class="panel-title">
                    Samtaler
                    <span class="conversation-count" id="conversation-count">0</span>
                </div>
                <div class="conversations-list" id="conversations-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¬</div>
                        <p>Ingen samtaler funnet</p>
                    </div>
                </div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel">
                <div id="no-conversation" class="no-conversation">
                    <p>Velg en samtale for Ã¥ starte</p>
                </div>
                <div id="chat-content" style="display: none; flex-direction: column; height: 100%;">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <div class="user-avatar" id="current-user-avatar">U</div>
                            <div class="user-details">
                                <h3 id="current-user-email">Bruker Email</h3>
                                <p id="conversation-created">Samtale startet: --</p>
                            </div>
                        </div>
                        <div class="conversation-actions">
                            <button class="action-btn" onclick="markAsRead()">Marker som Lest</button>
                            <button class="action-btn close" onclick="closeConversation()">Lukk Samtale</button>
                        </div>
                    </div>
                    <div class="messages-container" id="messages-container">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="reply-container">
                        <form class="reply-form" id="reply-form">
                            <textarea class="reply-input" id="reply-input" placeholder="Skriv et svar..."></textarea>
                            <button type="submit" class="reply-btn" id="reply-btn">
                                âž¤
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://eghxldvyyioolnithndr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnaHhsZHZ5eWlvb2xuaXRobmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjAyNzYsImV4cCI6MjA3MzIzNjI3Nn0.NAP799HhYrNkKRpSzXFXT0vyRd_OD-hkW8vH4VbOE8k';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let conversations = [];
        let currentConversationId = null;
        let conversationsSubscription = null;
        let messagesSubscription = null;

        // Check authentication and admin access
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            
            const userEmail = session.user.email;
            
            // Check if user is admin
            if (userEmail !== 'cyberbrothershq@gmail.com') {
                window.location.href = 'dashboard.html';
                return;
            }

            // Initialize admin panel
            initializeAdminPanel();
        }

        // Initialize admin panel
        async function initializeAdminPanel() {
            try {
                // Load initial data
                await loadConversations();
                await loadStats();
                
                // Set up subscriptions
                subscribeToConversations();
                
                // Check admin status
                await checkAdminStatus();
                
                // Update admin status every 30 seconds
                setInterval(updateLastSeen, 30000);
                
            } catch (error) {
                console.error('Error initializing admin panel:', error);
            }
        }

        // Load conversations
        async function loadConversations() {
            try {
                const { data, error } = await supabase
                    .from('chat_conversations')
                    .select(`
                        *,
                        chat_messages!inner(*)
                    `)
                    .order('last_message_at', { ascending: false });

                if (error) throw error;

                conversations = data || [];
                displayConversations();
                
            } catch (error) {
                console.error('Error loading conversations:', error);
                conversations = [];
                displayConversations();
            }
        }

        // Display conversations
        function displayConversations() {
            const conversationsList = document.getElementById('conversations-list');
            const conversationCount = document.getElementById('conversation-count');
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¬</div>
                        <p>Ingen samtaler funnet</p>
                    </div>
                `;
                conversationCount.textContent = '0';
                return;
            }

            conversationsList.innerHTML = '';
            conversationCount.textContent = conversations.length;

            conversations.forEach(conversation => {
                const lastMessage = conversation.chat_messages
                    ?.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                
                const unreadCount = conversation.chat_messages
                    ?.filter(msg => !msg.is_read && msg.sender_type === 'user').length || 0;

                const conversationElement = document.createElement('div');
                conversationElement.className = `conversation-item ${currentConversationId === conversation.id ? 'active' : ''}`;
                conversationElement.onclick = () => selectConversation(conversation.id);

                const lastMessageTime = conversation.last_message_at ? 
                    new Date(conversation.last_message_at).toLocaleString('no-NO', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Ingen meldinger';

                conversationElement.innerHTML = `
                    <div class="conversation-header">
                        <div class="user-email">${conversation.user_email}</div>
                        <div class="conversation-time">${lastMessageTime}</div>
                    </div>
                    <div class="last-message">
                        ${lastMessage ? lastMessage.message_text : 'Ingen meldinger ennÃ¥'}
                    </div>
                    <div class="conversation-status">
                        <span class="status-badge ${conversation.status}">${getStatusText(conversation.status)}</span>
                        ${unreadCount > 0 ? `<span class="unread-count">${unreadCount}</span>` : ''}
                    </div>
                `;

                conversationsList.appendChild(conversationElement);
            });
        }

        // Get status text in Norwegian
        function getStatusText(status) {
            const statusMap = {
                'open': 'Ã…pen',
                'pending': 'Venter',
                'closed': 'Lukket'
            };
            return statusMap[status] || status;
        }

        // Select conversation
        async function selectConversation(conversationId) {
            currentConversationId = conversationId;
            
            // Update UI to show selected conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Load conversation details
            await loadConversationDetails(conversationId);
            await loadMessages(conversationId);
            
            // Subscribe to messages for this conversation
            subscribeToMessages(conversationId);
            
            // Show chat content
            document.getElementById('no-conversation').style.display = 'none';
            document.getElementById('chat-content').style.display = 'flex';
        }

        // Load conversation details
        async function loadConversationDetails(conversationId) {
            try {
                const { data: conversation, error } = await supabase
                    .from('chat_conversations')
                    .select('*')
                    .eq('id', conversationId)
                    .single();

                if (error) throw error;

                // Update header
                document.getElementById('current-user-email').textContent = conversation.user_email;
                document.getElementById('current-user-avatar').textContent = conversation.user_email.charAt(0).toUpperCase();
                document.getElementById('conversation-created').textContent = 
                    `Samtale startet: ${new Date(conversation.created_at).toLocaleString('no-NO')}`;
                
            } catch (error) {
                console.error('Error loading conversation details:', error);
            }
        }

        // Load messages for conversation
        async function loadMessages(conversationId) {
            try {
                const { data: messages, error } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .eq('conversation_id', conversationId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '';

                if (messages && messages.length > 0) {
                    messages.forEach(message => {
                        displayMessage(message);
                    });
                    scrollToBottom();
                }
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display message
        // Display message (updated version)
// Display message (corrected version)
function displayMessage(message) {
    const messagesContainer = document.getElementById('messages-container');
    const messageElement = document.createElement('div');
    messageElement.className = `message ${message.sender_type}`;
    
    const time = new Date(message.created_at).toLocaleTimeString('no-NO', {
        hour: '2-digit',
        minute: '2-digit'
    });

    const senderText = message.sender_type === 'admin' ? 'Admin' : 'Bruker';
    
    // Map message types to Norwegian
    const messageTypeMap = {
        'support': 'Teknisk StÃ¸tte',
        'feedback': 'Tilbakemelding', 
        'feature': 'FunksjonsforespÃ¸rsel',
        'bug': 'Feilrapport',
        'other': 'Annet'
    };
    
    // Show message type for user messages (not admin messages)
    const shouldShowType = message.sender_type === 'user' && message.message_type && message.message_type !== 'text';
    const messageTypeText = shouldShowType ? messageTypeMap[message.message_type] || message.message_type : '';

    messageElement.innerHTML = `
        <div class="message-bubble">${message.message_text}</div>
        <div class="message-info">
            <span>${senderText} â€¢ ${time}</span>
            ${messageTypeText ? `<span class="message-type">${messageTypeText}</span>` : ''}
        </div>
    `;

    messagesContainer.appendChild(messageElement);
}

// Send reply (updated to use 'text' for admin messages)
document.getElementById('reply-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentConversationId) return;
    
    const input = document.getElementById('reply-input');
    const sendBtn = document.getElementById('reply-btn');
    const messageText = input.value.trim();
    
    if (!messageText) return;
    
    sendBtn.disabled = true;
    
    try {
        const { error } = await supabase
            .from('chat_messages')
            .insert([{
                conversation_id: currentConversationId,
                sender_email: 'cyberbrothershq@gmail.com',
                sender_type: 'admin',
                message_text: messageText,
                message_type: 'text'
            }]);

        if (error) throw error;
        
        input.value = '';
        input.style.height = 'auto';
        
        // Update conversation status to pending if it was closed
        await supabase
            .from('chat_conversations')
            .update({ status: 'pending' })
            .eq('id', currentConversationId)
            .eq('status', 'closed');
        
    } catch (error) {
        console.error('Error sending reply:', error);
        alert('Feil ved sending av svar. PrÃ¸v igjen.');
    } finally {
        sendBtn.disabled = false;
    }
});

        // Subscribe to conversations changes
        function subscribeToConversations() {
            conversationsSubscription = supabase
                .channel('conversations')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'chat_conversations'
                }, async () => {
                    await loadConversations();
                    await loadStats();
                })
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chat_messages'
                }, async () => {
                    await loadConversations();
                    await loadStats();
                    if (currentConversationId) {
                        await loadMessages(currentConversationId);
                    }
                })
                .subscribe();
        }

        // Subscribe to messages for current conversation
        function subscribeToMessages(conversationId) {
            if (messagesSubscription) {
                supabase.removeChannel(messagesSubscription);
            }

            messagesSubscription = supabase
                .channel(`messages-${conversationId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chat_messages',
                    filter: `conversation_id=eq.${conversationId}`
                }, (payload) => {
                    displayMessage(payload.new);
                    scrollToBottom();
                })
                .subscribe();
        }

        // Send reply
        document.getElementById('reply-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentConversationId) return;
            
            const input = document.getElementById('reply-input');
            const sendBtn = document.getElementById('reply-btn');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            sendBtn.disabled = true;
            
            try {
                const { error } = await supabase
                    .from('chat_messages')
                    .insert([{
                        conversation_id: currentConversationId,
                        sender_email: 'cyberbrothershq@gmail.com',
                        sender_type: 'admin',
                        message_text: messageText,
                        message_type: 'text'
                    }]);

                if (error) throw error;
                
                input.value = '';
                input.style.height = 'auto';
                
                // Update conversation status to pending if it was closed
                await supabase
                    .from('chat_conversations')
                    .update({ status: 'pending' })
                    .eq('id', currentConversationId)
                    .eq('status', 'closed');
                
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Feil ved sending av svar. PrÃ¸v igjen.');
            } finally {
                sendBtn.disabled = false;
            }
        });

        // Auto-resize textarea
        document.getElementById('reply-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 80) + 'px';
        });

        // Mark conversation as read
        async function markAsRead() {
            if (!currentConversationId) return;
            
            try {
                const { error } = await supabase
                    .from('chat_messages')
                    .update({ is_read: true })
                    .eq('conversation_id', currentConversationId)
                    .eq('sender_type', 'user');

                if (error) throw error;
                
                // Refresh conversations list
                await loadConversations();
                await loadStats();
                
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        // Close conversation
        async function closeConversation() {
            if (!currentConversationId) return;
            
            const confirmed = confirm('Er du sikker pÃ¥ at du vil lukke denne samtalen?');
            if (!confirmed) return;
            
            try {
                const { error } = await supabase
                    .from('chat_conversations')
                    .update({ status: 'closed' })
                    .eq('id', currentConversationId);

                if (error) throw error;
                
                // Refresh conversations list
                await loadConversations();
                await loadStats();
                
            } catch (error) {
                console.error('Error closing conversation:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                // Total conversations
                const { data: totalConversations, error: totalError } = await supabase
                    .from('chat_conversations')
                    .select('id', { count: 'exact' });

                if (totalError) throw totalError;

                // Open conversations
                const { data: openConversations, error: openError } = await supabase
                    .from('chat_conversations')
                    .select('id', { count: 'exact' })
                    .eq('status', 'open');

                if (openError) throw openError;

                // Unread messages
                const { data: unreadMessages, error: unreadError } = await supabase
                    .from('chat_messages')
                    .select('id', { count: 'exact' })
                    .eq('sender_type', 'user')
                    .eq('is_read', false);

                if (unreadError) throw unreadError;

                // Total messages
                const { data: totalMessages, error: messagesError } = await supabase
                    .from('chat_messages')
                    .select('id', { count: 'exact' });

                if (messagesError) throw messagesError;

                // Update UI
                document.getElementById('total-conversations').textContent = totalConversations?.length || 0;
                document.getElementById('open-conversations').textContent = openConversations?.length || 0;
                document.getElementById('unread-messages').textContent = unreadMessages?.length || 0;
                document.getElementById('total-messages').textContent = totalMessages?.length || 0;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Check admin status
        async function checkAdminStatus() {
            try {
                const { data: adminStatus, error } = await supabase
                    .from('admin_status')
                    .select('is_online')
                    .eq('admin_email', 'cyberbrothershq@gmail.com')
                    .single();

                if (error) throw error;

                const toggle = document.getElementById('status-toggle');
                toggle.checked = adminStatus?.is_online || false;
                
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }

        // Toggle admin online status
        document.getElementById('status-toggle').addEventListener('change', async (e) => {
            const isOnline = e.target.checked;
            
            try {
                const { error } = await supabase
                    .from('admin_status')
                    .update({ 
                        is_online: isOnline, 
                        last_seen: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('admin_email', 'cyberbrothershq@gmail.com');

                if (error) throw error;
                
            } catch (error) {
                console.error('Error updating admin status:', error);
                // Revert toggle if error
                e.target.checked = !isOnline;
            }
        });

        // Update last seen timestamp
        async function updateLastSeen() {
            try {
                const { error } = await supabase
                    .from('admin_status')
                    .update({ 
                        last_seen: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('admin_email', 'cyberbrothershq@gmail.com');

                if (error) throw error;
                
            } catch (error) {
                console.error('Error updating last seen:', error);
            }
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Sign out functionality
        async function signOut() {
            try {
                // Set admin offline before signing out
                await supabase
                    .from('admin_status')
                    .update({ 
                        is_online: false,
                        last_seen: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('admin_email', 'cyberbrothershq@gmail.com');

                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Feil ved utlogging:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });

        // Set admin offline when page is closed
        window.addEventListener('beforeunload', async () => {
            await supabase
                .from('admin_status')
                .update({ 
                    is_online: false,
                    last_seen: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .eq('admin_email', 'cyberbrothershq@gmail.com');
        });

        // Handle visibility change (when tab becomes inactive)
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden) {
                // Tab is hidden/inactive - set offline
                await supabase
                    .from('admin_status')
                    .update({ 
                        is_online: false,
                        last_seen: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('admin_email', 'cyberbrothershq@gmail.com');
            } else {
                // Tab is visible/active - check toggle state
                const toggle = document.getElementById('status-toggle');
                if (toggle && toggle.checked) {
                    await supabase
                        .from('admin_status')
                        .update({ 
                            is_online: true,
                            last_seen: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('admin_email', 'cyberbrothershq@gmail.com');
                }
            }
        });

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = 'auth.html';
            }
        });
    </script>
</body>
</html>