<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkademiTrack Tutorial</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
            color: #ffffff;
        }

        .tutorial-container {
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            color: #1f2937;
        }

        .tutorial-header {
            padding: 20px 40px 15px 40px;
            text-align: center;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            flex-shrink: 0;
            background: rgba(30, 58, 138, 0.1);
        }

        .tutorial-content {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .content-left {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
            background: #ffffff;
        }

        .content-right {
            flex: 1;
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, rgba(30, 58, 138, 0.1), rgba(59, 130, 246, 0.1));
            border-left: 1px solid rgba(59, 130, 246, 0.2);
        }

        .tutorial-step {
            display: none;
            height: 100%;
        }

        .tutorial-step.active {
            display: flex;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tutorial-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tutorial-subtitle {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .step-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-height: 100%;
        }

        .step-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.8rem;
        }

        .step-description {
            font-size: 1rem;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .name-input-container {
            margin: 1.5rem 0;
        }

        .name-input {
            width: 100%;
            max-width: 400px;
            padding: 16px 24px;
            font-size: 1.2rem;
            border: 2px solid #e5e7eb;
            border-radius: 50px;
            background: #f9fafb;
            color: #1f2937;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }

        .name-input:focus {
            border-color: #3b82f6;
            transform: scale(1.02);
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .name-input::placeholder {
            color: #9ca3af;
        }

        .tutorial-button, .download-button {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: flex-start;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0; /* Remove default margin */
        }

        .button-container {
            display: flex;
            gap: 1rem;
            align-items: stretch; /* Makes both buttons same height */
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .tutorial-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
            background: linear-gradient(45deg, #059669, #047857);
        }

        .tutorial-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #9ca3af;
        }

        .download-button {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-sizing: border-box; /* Ensures consistent sizing */
            min-height: 48px; /* Set minimum height */
        }

        .download-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
            background: linear-gradient(45deg, #2563eb, #1d4ed8);
        }

        .download-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #9ca3af;
        }

        .media-container {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed #d1d5db;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #6b7280;
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.1);
            position: relative;
            overflow: hidden;
        }

        .welcome-animation {
            font-size: 4rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-30px);
            }
            60% {
                transform: translateY(-15px);
            }
        }

        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .floating-book {
            position: absolute;
            font-size: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        .floating-book:nth-child(1) {
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .floating-book:nth-child(2) {
            top: 60%;
            right: 15%;
            animation-delay: 1s;
        }

        .floating-book:nth-child(3) {
            bottom: 30%;
            left: 20%;
            animation-delay: 2s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }

        .command-container {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 15px;
            margin: 1rem 0;
            border-left: 4px solid #3b82f6;
        }

        .command-input {
            width: 100%;
            padding: 10px 12px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            color: #1f2937;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 0.8rem 0;
        }

        .copy-button {
            background: #6b7280;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-left: 8px;
            transition: all 0.2s ease;
        }

        .copy-button:hover {
            background: #4b5563;
        }

        .terminal-steps {
            text-align: left;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 15px;
            border-radius: 12px;
            margin: 1rem 0;
        }

        .terminal-steps h4 {
            color: #3b82f6;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }

        .terminal-steps ol {
            margin: 0;
            padding-left: 18px;
        }

        .terminal-steps li {
            margin: 6px 0;
            line-height: 1.4;
            color: #4b5563;
            font-size: 0.9rem;
        }

        .warning-box, .success-box {
            border-radius: 8px;
            padding: 12px;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .success-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #065f46;
            border-radius: 8px;
            padding: 16px;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .success-box ul {
            margin: 10px 0 !important;
            padding-left: 20px !important;
        }

        .success-box li {
            margin: 8px 0 !important;
            line-height: 1.5 !important;
        }

        .os-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #1e40af;
            border-radius: 8px;
            padding: 12px;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(30, 58, 138, 0.2);
            border-radius: 3px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(30, 58, 138, 0.3);
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #3b82f6;
            transform: scale(1.2);
        }

        .congratulations {
            font-size: 2.5rem;
            margin: 1rem 0;
            text-align: center;
        }

        .completion-content {
            text-align: center;
        }

        .auto-redirect-text {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 1rem 0;
            font-style: italic;
        }

        .countdown {
            font-weight: bold;
            color: #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tutorial-container {
                height: 95vh;
                margin: 10px;
            }

            .tutorial-header {
                padding: 15px 20px 10px 20px;
            }

            .tutorial-title {
                font-size: 1.5rem;
            }

            .tutorial-content {
                flex-direction: column;
            }

            .content-left, .content-right {
                flex: none;
                padding: 15px;
            }

            .content-right {
                max-height: 200px;
                border-left: none;
                border-top: 1px solid rgba(59, 130, 246, 0.2);
            }

            .step-title {
                font-size: 1.3rem;
            }

            .step-description {
                font-size: 0.95rem;
            }

            .media-container {
                max-width: 100%;
                height: 180px;
            }
        }

        /* Special styling for step 3 to ensure everything fits */
        #step-3 .content-left {
            justify-content: flex-start;
            padding-top: 15px; /* Reduced from 20px */
        }

        #step-3 .step-content {
            justify-content: flex-start;
            gap: 0.6rem; /* Reduced from 0.8rem */
        }

        #step-3 .step-title {
            margin-bottom: 0.6rem; /* Reduce title margin */
        }

        #step-3 .step-description {
            margin-bottom: 1rem; /* Reduce description margin */
        }

        #step-3 .terminal-steps,
        #step-3 .command-container,
        #step-3 .warning-box,
        #step-3 .success-box {
            margin: 0.6rem 0; /* Reduced from 0.8rem */
        }
    </style>
</head>
<body>
    <div class="tutorial-container">
        <!-- Header with progress -->
        <div class="tutorial-header">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>
            <div class="tutorial-title">AkademiTrack Setup</div>
        </div>

        <!-- Step 1: Welcome and Name Input -->
        <div class="tutorial-step active" id="step-1">
            <div class="tutorial-content">
                <div class="content-left">
                    <div class="step-content">
                        <div class="step-title">Hei! Velkommen til AkademiTrack!</div>
                        <div class="step-description">
                            La oss komme i gang med å sette opp din personlige studieopplevelse.
                            Først - hva kan vi kalle deg?
                        </div>

                        <div class="name-input-container">
                            <input 
                                type="text" 
                                class="name-input" 
                                id="user-name-input" 
                                placeholder="Skriv inn navnet ditt her..."
                                maxlength="50"
                            >
                        </div>

                        <button class="tutorial-button" onclick="goToStep(2)" id="name-next-btn" disabled>
                            Fortsett
                        </button>
                    </div>
                </div>
                <div class="content-right">
                    <div class="media-container">
                        <div class="floating-elements">
                            <div class="floating-book">📚</div>
                            <div class="floating-book">📖</div>
                            <div class="floating-book">📝</div>
                        </div>
                        <div class="welcome-animation">👋</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: App Installation -->
        <div class="tutorial-step" id="step-2">
            <div class="tutorial-content">
                <div class="content-left">
                    <div class="step-content">
                        <div class="step-title">Last ned AkademiTrack</div>
                        <div class="step-description" id="install-greeting">
                            Hei <span id="user-name-display"></span>! Nå skal vi laste ned og installere AkademiTrack-appen.
                        </div>

                        <div class="os-info" id="os-info">
                            <strong>Operativsystem oppdaget:</strong> <span id="detected-os">Sjekker...</span><br>
                            <strong>Fil som lastes ned:</strong> <span id="download-filename">...</span>
                        </div>

                        <div class="warning-box">
                            <strong>Viktig:</strong> Sørg for at du laster ned appen fra en sikker kilde og at du har tilstrekkelig lagringsplass.
                        </div>

                        <div class="button-container">
                            <button class="download-button" onclick="startDownload()" id="install-btn">
                                <span>📥</span>
                                <span id="download-text">Last ned AkademiTrack</span>
                            </button>
                            
                            <button class="download-button" onclick="goToStep(3)" id="already-downloaded-btn" style="background: linear-gradient(45deg, #6b7280, #4b5563);">
                                Allerede lastet ned
                            </button>
                        </div>

                        <div id="download-status" style="margin-top: 1rem; display: none;">
                            <p style="color: #059669;">⏳ Nedlasting pågår... Vennligst vent.</p>
                        </div>

                        <button class="tutorial-button" onclick="goToStep(3)" id="install-next-btn" disabled style="margin-top: 1rem;">
                            Neste - Jeg har installert appen
                        </button>
                    </div>
                </div>
                <div class="content-right">
                    <div class="media-container">
                        <div style="font-size: 3rem; animation: pulse 2s infinite;">📱</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Terminal Commands -->
        <div class="tutorial-step" id="step-3">
            <div class="tutorial-content">
                <div class="content-left">
                    <div class="step-content">
                        <div class="step-title" id="step3-title">Fjern sikkerhetsbegrensninger</div>
                        <div class="step-description" id="step3-description">
                            For å kunne kjøre appen må vi fjerne macOS sine sikkerhetsbegrensninger.
                            Ikke bekymre deg - dette er helt trygt!
                        </div>

                        <div class="terminal-steps" id="terminal-instructions">
                            <h4>Følg disse stegene:</h4>
                            <ol id="terminal-steps-list">
                                <li>Åpne Terminal (trykk Cmd + Space, skriv "Terminal")</li>
                                <li>Kopier kommandoen nedenfor</li>
                                <li>Lim den inn i Terminal og trykk Enter</li>
                                <li>Vent til kommandoen er ferdig</li>
                            </ol>
                        </div>

                        <div class="command-container" id="command-section">
                            <p><strong>Kommando å kopiere:</strong></p>
                            <input 
                                type="text" 
                                class="command-input" 
                                id="terminal-command" 
                                value="xattr -cr ~/Downloads/AkademiTrack.app"
                                readonly
                            >
                            <button class="copy-button" onclick="copyCommand()">📋 Kopier</button>
                        </div>

                        <div class="success-box" id="step3-tip">
                            <strong>Tips:</strong> Hvis du ikke finner appen i Downloads, sjekk hvor du lagret den og erstatt stien i kommandoen.
                        </div>

                        <button class="tutorial-button" onclick="goToStep(4)">
                            Neste - Jeg har kjørt kommandoen
                        </button>
                    </div>
                </div>
                <div class="content-right">
                    <div class="media-container">
                        <div style="font-size: 3rem; animation: pulse 2s infinite;">💻</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Completion -->
        <div class="tutorial-step" id="step-4">
            <div class="tutorial-content">
                <div class="content-left">
                    <div class="step-content">
                        <div class="completion-content">
                            <div class="congratulations">🎉</div>
                            <div class="step-title">Gratulerer!</div>
                            <div class="step-description">
                                Du har fullført oppsettet! Nå kan du åpne AkademiTrack-programmet og begynne å spore studieprogresjonen din.
                                Len deg tilbake og registrer i fred - alt er klart for deg!
                            </div>

                            <div class="success-box">
                                <p><strong>Du kan nå:</strong></p>
                                <ul style="text-align: left; margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                                    <li style="margin: 8px 0;">Åpne AkademiTrack-appen</li>
                                    <li style="margin: 8px 0;">Bruke aktiveringsnøkkelen din til å logge inn</li>
                                    <li style="margin: 8px 0;">Begynne å spore dine studieøkter</li>
                                </ul>
                            </div>

                            <div class="auto-redirect-text">
                                Omdirigerer automatisk til dashboard om <span class="countdown" id="countdown">5</span> sekunder...
                            </div>

                            <button class="tutorial-button" onclick="completeTutorial()">
                                Gå til Dashboard nå
                            </button>
                        </div>
                    </div>
                </div>
                <div class="content-right">
                    <div class="media-container">
                        <div style="font-size: 4rem; animation: bounce 2s infinite;">✅</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://eghxldvyyioolnithndr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnaHhsZHZ5eWlvb2xuaXRobmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjAyNzYsImV4cCI6MjA3MzIzNjI3Nn0.NAP799HhYrNkKRpSzXFXT0vyRd_OD-hkW8vH4VbOE8k';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentStep = 1;
        let userName = '';
        let userEmail = '';
        let countdownTimer;
        let userOS = '';
        let downloadURL = '';

        // OS Detection and Download URLs
        const GITHUB_RELEASES = {
            baseURL: 'https://github.com/CyberGutta/AkademiTrack/releases/download/v1.0.0/',
            files: {
                windows: 'Windows.zip',
                mac: 'Mac.zip',
                linux: 'Linux.zip'
            }
        };

        // Detect user's operating system
        function detectOS() {
            const userAgent = window.navigator.userAgent.toLowerCase();
            const platform = window.navigator.platform.toLowerCase();
            
            if (platform.includes('mac') || userAgent.includes('mac')) {
                return 'mac';
            } else if (platform.includes('win') || userAgent.includes('win')) {
                return 'windows';
            } else if (platform.includes('linux') || userAgent.includes('linux')) {
                return 'linux';
            } else {
                // Fallback detection
                if (userAgent.includes('mac os x') || userAgent.includes('macintosh')) {
                    return 'mac';
                } else if (userAgent.includes('windows nt')) {
                    return 'windows';
                } else {
                    return 'linux'; // Default fallback
                }
            }
        }

        // Get OS display name
        function getOSDisplayName(os) {
            switch(os) {
                case 'mac': return 'macOS';
                case 'windows': return 'Windows';
                case 'linux': return 'Linux';
                default: return 'Ukjent';
            }
        }

        // Update OS-specific content
        function updateOSContent() {
            userOS = detectOS();
            const filename = GITHUB_RELEASES.files[userOS];
            downloadURL = GITHUB_RELEASES.baseURL + filename;
            
            // Update step 2 content
            const detectedOSElement = document.getElementById('detected-os');
            const downloadFilenameElement = document.getElementById('download-filename');
            
            if (detectedOSElement) {
                detectedOSElement.textContent = getOSDisplayName(userOS);
            }
            
            if (downloadFilenameElement) {
                downloadFilenameElement.textContent = filename;
            }
            
            // Update step 3 content based on OS
            updateStep3Content();
        }

        // Update Step 3 content based on OS
        function updateStep3Content() {
            const title = document.getElementById('step3-title');
            const description = document.getElementById('step3-description');
            const stepsList = document.getElementById('terminal-steps-list');
            const commandInput = document.getElementById('terminal-command');
            const tip = document.getElementById('step3-tip');
            
            if (userOS === 'mac') {
                if (title) title.textContent = 'Fjern sikkerhetsbegrensninger (macOS)';
                if (description) {
                    description.textContent = 'For å kunne kjøre appen må vi fjerne macOS sine sikkerhetsbegrensninger. Ikke bekymre deg - dette er helt trygt!';
                }
                if (stepsList) {
                    stepsList.innerHTML = `
                        <li>Åpne Terminal (trykk Cmd + Space, skriv "Terminal")</li>
                        <li>Kopier kommandoen nedenfor</li>
                        <li>Lim den inn i Terminal og trykk Enter</li>
                        <li>Vent til kommandoen er ferdig</li>
                    `;
                }
                if (commandInput) {
                    commandInput.value = 'xattr -cr ~/Downloads/AkademiTrack.app';
                }
                if (tip) {
                    tip.innerHTML = '<strong>Tips:</strong> Hvis du ikke finner appen i Downloads, sjekk hvor du lagret den og erstatt stien i kommandoen.';
                }
            } else if (userOS === 'linux') {
                if (title) title.textContent = 'Gjør filen kjørbar (Linux)';
                if (description) {
                    description.textContent = 'For Linux må vi gjøre filen kjørbar og eventuelt starte den. Dette er standard prosedyre for Linux-applikasjoner.';
                }
                if (stepsList) {
                    stepsList.innerHTML = `
                        <li>Åpne Terminal (Ctrl + Alt + T)</li>
                        <li>Naviger til mappen der du pakket ut filen</li>
                        <li>Kopier og kjør kommandoen nedenfor</li>
                        <li>Test om appen starter med: ./AkademiTrack</li>
                    `;
                }
                if (commandInput) {
                    commandInput.value = 'chmod +x ./AkademiTrack';
                }
                if (tip) {
                    tip.innerHTML = '<strong>Tips:</strong> Husk å pakke ut zip-filen først, og naviger til riktig mappe i Terminal før du kjører kommandoen.';
                }
            } else { // Windows
                if (title) title.textContent = 'Windows Defender og SmartScreen';
                if (description) {
                    description.textContent = 'Windows kan vise en sikkerhetsadvarsel. Dette er normalt for nye applikasjoner. Du kan trykt kjøre appen likevel.';
                }
                if (stepsList) {
                    stepsList.innerHTML = `
                        <li>Pakk ut zip-filen til en mappe</li>
                        <li>Høyreklikk på AkademiTrack.exe</li>
                        <li>Velg "Egenskaper" → "Avblokker" → "OK"</li>
                        <li>Dobbeltklikk på filen for å starte</li>
                    `;
                }
                
                // Hide command section for Windows
                const commandSection = document.getElementById('command-section');
                if (commandSection) {
                    commandSection.style.display = 'none';
                }
                
                if (tip) {
                    tip.innerHTML = '<strong>Tips:</strong> Hvis Windows Defender blokkerer appen, klikk "Mer info" og deretter "Kjør likevel".';
                }
            }
        }

        // Email validation function
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Save user name to database
        async function saveUserNameToDatabase(userEmail, displayName) {
            try {
                if (!userEmail || !displayName) return false;
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .upsert([{
                        user_email: userEmail,
                        display_name: displayName.trim(),
                        tutorial_completed: false,
                        updated_at: new Date().toISOString()
                    }], { onConflict: 'user_email' })
                    .select();

                if (error) {
                    console.error('Error saving user name:', error);
                    return false;
                }
                
                console.log('User name saved to database:', data);
                return true;
            } catch (error) {
                console.error('Error in saveUserNameToDatabase:', error);
                return false;
            }
        }

        // Mark tutorial as completed in database
        async function markTutorialCompleted(userEmail) {
            try {
                const { error } = await supabase
                    .from('user_profiles')
                    .upsert([{
                        user_email: userEmail,
                        tutorial_completed: true,
                        tutorial_completed_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }], { onConflict: 'user_email' })
                    .select();

                if (error) {
                    console.error('Error marking tutorial as completed:', error);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error in markTutorialCompleted:', error);
                return false;
            }
        }

        // Check auth and redirect if not logged in
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session || !session.user || !session.user.email) {
                window.location.href = 'index.html';
                return null;
            }
            
            userEmail = session.user.email;
            
            // Check if admin
            if (userEmail === 'cyberbrothershq@gmail.com') {
                window.location.href = 'admin.html';
                return null;
            }
            
            return userEmail;
        }

        // Navigate to specific step
        async function goToStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > 4) return;
    
            // Skip database operations if in readonly mode
            if (window.isReadOnlyMode) {
                // Use the readonly version
                return;
            }
            
            // Save user name when leaving step 1
            if (currentStep === 1 && stepNumber > 1) {
                const nameInput = document.getElementById('user-name-input');
                userName = nameInput ? nameInput.value.trim() : '';
                
                if (!userName || userName.length < 2) {
                    alert('Vennligst skriv inn navnet ditt først!');
                    return;
                }
                
                // Save to database
                if (userEmail) {
                    const saved = await saveUserNameToDatabase(userEmail, userName);
                    if (!saved) {
                        alert('Kunne ikke lagre navnet. Prøv igjen.');
                        return;
                    }
                }
                
                // Update greeting in step 2
                const displayElement = document.getElementById('user-name-display');
                if (displayElement) {
                    displayElement.textContent = userName;
                }
            }
            
            // Hide current step
            const currentStepEl = document.getElementById(`step-${currentStep}`);
            if (currentStepEl) {
                currentStepEl.classList.remove('active');
            }
            
            // Update step indicator
            const currentDot = document.querySelector(`.step-dot[data-step="${currentStep}"]`);
            const nextDot = document.querySelector(`.step-dot[data-step="${stepNumber}"]`);
            
            if (currentDot) currentDot.classList.remove('active');
            if (nextDot) nextDot.classList.add('active');
            
            // Show new step
            const newStepEl = document.getElementById(`step-${stepNumber}`);
            if (newStepEl) {
                newStepEl.classList.add('active');
            }
            
            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                const progressPercent = (stepNumber / 4) * 100;
                progressFill.style.width = `${progressPercent}%`;
            }
            
            currentStep = stepNumber;
        }

        // Start download process
        function startDownload() {
            if (!downloadURL) {
                alert('Kunne ikke bestemme nedlastingslenke. Prøv å laste siden på nytt.');
                return;
            }
            
            const downloadBtn = document.getElementById('install-btn');
            const downloadStatus = document.getElementById('download-status');
            const nextBtn = document.getElementById('install-next-btn');
            const downloadText = document.getElementById('download-text');
            
            if (downloadBtn) {
                downloadBtn.disabled = true;
                if (downloadText) {
                    downloadText.textContent = 'Laster ned...';
                }
            }
            
            if (downloadStatus) {
                downloadStatus.style.display = 'block';
            }
            
            // Start the actual download
            try {
                const link = document.createElement('a');
                link.href = downloadURL;
                link.download = GITHUB_RELEASES.files[userOS];
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Download error:', error);
                alert('Nedlasting feilet. Prøv igjen eller last ned manuelt fra GitHub.');
                
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    if (downloadText) {
                        downloadText.textContent = 'Last ned AkademiTrack';
                    }
                }
                if (downloadStatus) {
                    downloadStatus.style.display = 'none';
                }
                return;
            }
            
            // Simulate download completion after a delay
            setTimeout(() => {
                if (downloadBtn && downloadText) {
                    downloadText.textContent = '✅ Nedlasting fullført!';
                }
                if (downloadStatus) {
                    downloadStatus.innerHTML = '<p style="color: #059669;">✅ AkademiTrack er lastet ned! Du kan nå gå til neste trinn.</p>';
                }
                if (nextBtn) {
                    nextBtn.disabled = false;
                    nextBtn.style.opacity = '1';
                }
            }, 2000);
        }

        // Copy terminal command
        function copyCommand() {
            const commandInput = document.getElementById('terminal-command');
            if (!commandInput) return;
            
            commandInput.select();
            commandInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                const copyBtn = event.target;
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅ Kopiert!';
                copyBtn.style.background = '#059669';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#6b7280';
                }, 2000);
            } catch (err) {
                console.error('Kunne ikke kopiere tekst:', err);
                
                // Fallback: try modern clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(commandInput.value).then(() => {
                        const copyBtn = event.target;
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = '✅ Kopiert!';
                        copyBtn.style.background = '#059669';
                        
                        setTimeout(() => {
                            copyBtn.textContent = originalText;
                            copyBtn.style.background = '#6b7280';
                        }, 2000);
                    }).catch(() => {
                        alert('Kunne ikke kopiere automatisk. Vennligst merk teksten og kopier manuelt.');
                    });
                } else {
                    alert('Kunne ikke kopiere automatisk. Vennligst merk teksten og kopier manuelt.');
                }
            }
        }

        // Complete tutorial and redirect
        async function completeTutorial() {
            // Clear any existing countdown
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            
            // Mark tutorial as completed in database
            if (userEmail) {
                await markTutorialCompleted(userEmail);
            }
            
            // Redirect to dashboard
            window.location.href = 'dashboard.html';
        }

        // Start countdown for automatic redirect
        function startCountdown() {
            let timeLeft = 5;
            const countdownElement = document.getElementById('countdown');
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                if (countdownElement) {
                    countdownElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    completeTutorial();
                }
            }, 1000);
        }

        // Initialize tutorial
        async function initializeTutorial() {
            const email = await checkAuth();
            if (!email) return;
            
            // Check for readonly mode FIRST
            const urlParams = new URLSearchParams(window.location.search);
            const isReadOnly = urlParams.get('readonly') === 'true';
            
            if (isReadOnly) {
                // Set up readonly tutorial without checking completion status
                setupReadOnlyTutorial();
                updateOSContent();
                return;
            }
            
            // Only check tutorial completion if NOT in readonly mode
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('tutorial_completed')
                    .eq('user_email', email)
                    .maybeSingle();

                if (error) {
                    console.error('Error checking tutorial status:', error);
                } else if (data?.tutorial_completed === true) {
                    // User has already completed tutorial, redirect to dashboard
                    window.location.href = 'dashboard.html';
                    return;
                }
            } catch (dbError) {
                console.error('Database error checking tutorial completion:', dbError);
            }
            
            // Initialize OS detection and content
            updateOSContent();
            
            // Set up name input listener
            const nameInput = document.getElementById('user-name-input');
            const nextBtn = document.getElementById('name-next-btn');
            
            if (nameInput && nextBtn) {
                nameInput.addEventListener('input', function() {
                    const name = this.value.trim();
                    if (name.length >= 2) {
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                    } else {
                        nextBtn.disabled = true;
                        nextBtn.style.opacity = '0.5';
                    }
                });
                
                // Allow Enter key to proceed
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !nextBtn.disabled) {
                        goToStep(2);
                    }
                });
                
                // Focus on name input
                nameInput.focus();
            }
        }

        function setupReadOnlyTutorial() {
            // Start on step 2 instead of step 1
            currentStep = 2;
            
            // Hide step 1 and show step 2
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            if (step1) step1.classList.remove('active');
            if (step2) step2.classList.add('active');
            
            // Update progress indicators to show 3 steps instead of 4
            const stepIndicator = document.querySelector('.step-indicator');
            if (stepIndicator) {
                stepIndicator.innerHTML = `
                    <div class="step-dot active" data-step="2"></div>
                    <div class="step-dot" data-step="3"></div>
                    <div class="step-dot" data-step="4"></div>
                `;
            }
            
            // Update progress bar to show step 2 as step 1
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                progressFill.style.width = '33.33%'; // 1/3 instead of 2/4
            }
            
            // Set up the greeting with a generic name
            const displayElement = document.getElementById('user-name-display');
            if (displayElement) {
                displayElement.textContent = 'Tutorial Bruker';
            }
            
            // Show readonly notice
            const tutorialTitle = document.querySelector('.tutorial-title');
            if (tutorialTitle) {
                tutorialTitle.insertAdjacentHTML('afterend', 
                    '<div style="background: rgba(59, 130, 246, 0.1); padding: 0.5rem 1rem; border-radius: 8px; margin-top: 0.5rem; font-size: 0.9rem; color: #1e40af;">📖 Du ser gjennom tutorialen - ingen endringer vil bli lagret</div>'
                );
            }
            
            // Override goToStep for readonly mode with 3-step navigation
            window.isReadOnlyMode = true;
            
            if (!window.originalGoToStep) {
                window.originalGoToStep = goToStep;
                window.originalCompleteTutorial = completeTutorial;
            }
            
            window.goToStep = function(stepNumber) {
                // Only allow steps 2, 3, 4 in readonly mode
                if (stepNumber < 2 || stepNumber > 4) return;
                
                // Update step display
                const currentStepEl = document.getElementById(`step-${currentStep}`);
                const newStepEl = document.getElementById(`step-${stepNumber}`);
                
                if (currentStepEl) currentStepEl.classList.remove('active');
                if (newStepEl) newStepEl.classList.add('active');
                
                // Update step indicators (3 dots representing steps 2,3,4)
                const currentDot = document.querySelector(`.step-dot[data-step="${currentStep}"]`);
                const nextDot = document.querySelector(`.step-dot[data-step="${stepNumber}"]`);
                
                if (currentDot) currentDot.classList.remove('active');
                if (nextDot) nextDot.classList.add('active');
                
                // Update progress bar (treat step 2 as 1/3, step 3 as 2/3, step 4 as 3/3)
                const progressFill = document.getElementById('progress-fill');
                if (progressFill) {
                    const progressPercent = ((stepNumber - 1) / 3) * 100; // -1 to adjust for starting at step 2
                    progressFill.style.width = `${progressPercent}%`;
                }
                
                currentStep = stepNumber;
                
                // Set greeting for step 2
                if (stepNumber === 2) {
                    const displayElement = document.getElementById('user-name-display');
                    if (displayElement) {
                        displayElement.textContent = 'Tutorial Bruker';
                    }
                }
            };
            
            // Override completion function for readonly
            window.completeTutorial = function() {
                // Clear any existing countdown
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                }
                
                // In readonly mode, go back to dashboard
                window.location.href = 'dashboard.html';
            };

            window.startCountdown = function() {
                // In readonly mode, don't start countdown, just show completion message
                const countdownElement = document.getElementById('countdown');
                const autoRedirectText = document.querySelector('.auto-redirect-text');
                
                if (autoRedirectText) {
                    autoRedirectText.innerHTML = 'Klikk knappen under for å gå tilbake til dashboard.';
                }
                
                if (countdownElement) {
                    countdownElement.style.display = 'none'; // Hide the countdown span
                }
            };
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTutorial();
            
            // Start countdown when step 4 is reached
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const step4 = document.getElementById('step-4');
                        if (step4 && step4.classList.contains('active') && !countdownTimer) {
                            startCountdown();
                        }
                    }
                });
            });
            
            const step4 = document.getElementById('step-4');
            if (step4) {
                observer.observe(step4, { attributes: true });
            }
        });
    </script>
</body>
</html>